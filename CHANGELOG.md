# История изменений

## v1.4.0 (2026-01-23)

### Новые возможности
- **Вложенные XML структуры для пользовательских полей товаров и категорий**
  - Добавлена возможность создавать вложенные XML теги через JSON структуру
  - Новый тип поля в пользовательских полях: "Текст" или "Вложенный"
  - Поддержка плейсхолдеров внутри вложенных структур
  - Рекурсивная обработка многоуровневых JSON структур
  - Визуальные примеры использования в интерфейсе товаров и категорий

### Примеры использования

**Простой список элементов (JSON):**
```json
{
  "Option": ["Газобетон", "Пенобетон", "Гипсокартон", "Бетонные блоки"]
}
```

**XML результат с тегом Purpose:**
```xml
<Purpose>
  <Option>Газобетон</Option>
  <Option>Пенобетон</Option>
  <Option>Гипсокартон</Option>
  <Option>Бетонные блоки</Option>
</Purpose>
```

**Вложенная структура с объектами (JSON):**
```json
{
  "Material": {
    "Type": "Газобетон",
    "Density": "D500",
    "Grade": "B2.5"
  }
}
```

**XML результат:**
```xml
<Specification>
  <Material>
    <Type>Газобетон</Type>
    <Density>D500</Density>
    <Grade>B2.5</Grade>
  </Material>
</Specification>
```

### Технические детали
- Добавлена колонка "Тип" в таблицы пользовательских полей товаров и категорий
- Обновлены функции сохранения для поддержки типа поля (`text` или `nested`)
- Добавлена обработка типа `nested` в `wc_avito_add_dynamic_fields()` для пользовательских полей
- Использование существующей функции `wc_avito_add_nested_xml_elements()` для обработки JSON
- Логирование ошибок парсинга JSON для отладки

### Изменения в файлах
- `includes/dynamic-product-fields.php` - добавлена колонка "Тип" и обновлен шаблон строки
- `includes/category-export-field.php` - добавлена колонка "Тип" и обновлен шаблон строки
- `includes/xml-generator-dynamic.php` - добавлена обработка nested полей для товаров и категорий
- `avito-uralgips.php` - обновлена версия плагина до 1.4.0
- `README.md` - добавлена документация с примерами вложенных структур

---

## v1.3.0 (2026-01-23)

### Новые возможности
- **Поддержка вложенных XML структур (Nested)** для глобальных полей
  - Новый тип поля "nested" для создания сложных XML структур
  - Поддержка JSON формата для описания вложенности
  - Рекурсивная обработка вложенных элементов
  - Обработка плейсхолдеров на всех уровнях вложенности
  - Поддержка как ассоциативных массивов, так и списков

### Технические детали
- Добавлена функция `wc_avito_add_nested_xml_elements()` в `xml-generator-dynamic.php`
- Обновлена функция `wc_avito_add_dynamic_fields()` для обработки полей типа `nested`
- Использование `SimpleXMLElement` для создания вложенных XML элементов

---

## v1.2.0 (2026-01-23)

### Новые возможности
- **Условия генерации полей** - добавлена система условной генерации глобальных полей
  - Новая колонка "Условие генерации" на странице настроек глобальных полей
  - Поддержка плейсхолдеров в условиях (все те же, что и в значениях полей)
  - Поддерживаемые операторы сравнения:
    - `=` - равно
    - `!=` - не равно
    - `>` - больше (для числовых значений)
    - `<` - меньше (для числовых значений)
    - `>=` - больше или равно (для числовых значений)
    - `<=` - меньше или равно (для числовых значений)
    - `contains` - содержит (регистронезависимый поиск подстроки)
    - `!contains` - не содержит (регистронезависимый поиск подстроки)

### Примеры использования

**Добавление поля только для определенной категории:**
```
Условие: {category_name}=Керамзит
```

**Добавление поля для товаров дороже 1000 рублей:**
```
Условие: {product_price}>1000
```

**Добавление поля для товаров, содержащих слово в названии:**
```
Условие: {product_name} contains кирпич
```

**Добавление поля только для товаров в наличии:**
```
Условие: {meta:_stock_status}=instock
```

**Добавление поля для товаров с определенным атрибутом:**
```
Условие: {attribute:pa_color}!=красный
```

### Технические детали
- Добавлена функция `wc_avito_check_field_condition()` для проверки условий
- Обновлена структура данных глобальных полей (добавлено поле `condition`)
- Условия обрабатываются перед генерацией поля в XML
- Если условие не указано, поле генерируется всегда (как раньше)
- Логирование ошибок при неверном формате условия

### Изменения в файлах
- `includes/field-settings-page.php` - добавлена колонка "Условие генерации" с подсказками
- `includes/xml-generator-dynamic.php` - добавлена функция проверки условий и её вызов
- `includes/field-manager.php` - обновлены дефолтные настройки полей
- `avito-uralgips.php` - обновлена версия плагина до 1.2.0
- `README.md` - добавлена документация по новому функционалу

---

## v1.1.1 (предыдущая версия)

### Улучшения
- Защита от случайного удаления полей Авито в категориях
- Добавлен заголовок 'Характеристики' перед списком атрибутов в плейсхолдере `{product_attributes_list}`
- Добавлен плейсхолдер `{current_date}` для вывода текущей даты в формате "19 января"
- Обновлен `.gitignore`

---

## v1.1.0 и ранее

- Полностью динамическая система полей
- Удалена зависимость от ACF
- Система плейсхолдеров для шаблонов
- Контроль экспорта через категории
- Индивидуальный контроль экспорта товаров
- Пользовательские поля категорий
- Автоматическая генерация XML по расписанию
