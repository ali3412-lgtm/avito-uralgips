# Руководство по вложенным XML полям

## Что такое вложенные поля?

Вложенные поля позволяют создавать сложные XML структуры с несколькими уровнями вложенности для пользовательских полей товаров и категорий.

## Где использовать?

### Для товаров:
1. Откройте товар для редактирования
2. Перейдите на вкладку **"Avito"**
3. В разделе **"Пользовательские поля товара"** нажмите **"Добавить поле"**
4. Заполните:
   - **XML тег** - название корневого элемента (например, `Purpose`)
   - **Значение** - JSON структура (см. примеры ниже)
   - **Тип** - выберите **"Вложенный"**

### Для категорий:
1. Перейдите в **Товары → Категории**
2. Отредактируйте нужную категорию
3. В блоке **"Настройки Avito"** найдите **"Пользовательские поля категории"**
4. Нажмите **"Добавить поле"**
5. Заполните аналогично товарам

## Формат JSON

### Базовый синтаксис

```json
{
  "ИмяТега": "значение"
}
```

или для списка:

```json
{
  "ИмяТега": ["значение1", "значение2", "значение3"]
}
```

## Примеры использования

### Пример 1: Простой список опций

**XML тег:** `Purpose`

**JSON значение:**
```json
{
  "Option": ["Газобетон", "Пенобетон", "Гипсокартон", "Бетонные блоки"]
}
```

**Результат в XML:**
```xml
<Purpose>
  <Option>Газобетон</Option>
  <Option>Пенобетон</Option>
  <Option>Гипсокартон</Option>
  <Option>Бетонные блоки</Option>
</Purpose>
```

---

### Пример 2: Вложенная структура с характеристиками

**XML тег:** `Specification`

**JSON значение:**
```json
{
  "Material": {
    "Type": "Газобетон",
    "Density": "D500",
    "Grade": "B2.5"
  }
}
```

**Результат в XML:**
```xml
<Specification>
  <Material>
    <Type>Газобетон</Type>
    <Density>D500</Density>
    <Grade>B2.5</Grade>
  </Material>
</Specification>
```

---

### Пример 3: Множественные элементы с вложенностью

**XML тег:** `Properties`

**JSON значение:**
```json
{
  "Property": [
    {
      "Name": "Размер",
      "Value": "600x300x200"
    },
    {
      "Name": "Вес",
      "Value": "25 кг"
    }
  ]
}
```

**Результат в XML:**
```xml
<Properties>
  <Property>
    <Name>Размер</Name>
    <Value>600x300x200</Value>
  </Property>
  <Property>
    <Name>Вес</Name>
    <Value>25 кг</Value>
  </Property>
</Properties>
```

---

### Пример 4: Использование плейсхолдеров

**XML тег:** `Details`

**JSON значение:**
```json
{
  "Option": [
    "{category_name}",
    "Цена: {product_price} руб.",
    "Артикул: {product_sku}"
  ]
}
```

**Результат в XML** (для товара из категории "Стройматериалы", ценой 5990 руб., артикулом ABC123):
```xml
<Details>
  <Option>Стройматериалы</Option>
  <Option>Цена: 5990 руб.</Option>
  <Option>Артикул: ABC123</Option>
</Details>
```

---

### Пример 5: Сложная многоуровневая структура

**XML тег:** `TechSpec`

**JSON значение:**
```json
{
  "Dimensions": {
    "Length": "600",
    "Width": "300",
    "Height": "200",
    "Unit": "мм"
  },
  "Weight": {
    "Value": "25",
    "Unit": "кг"
  },
  "Features": {
    "Feature": ["Морозостойкий", "Экологичный", "Прочный"]
  }
}
```

**Результат в XML:**
```xml
<TechSpec>
  <Dimensions>
    <Length>600</Length>
    <Width>300</Width>
    <Height>200</Height>
    <Unit>мм</Unit>
  </Dimensions>
  <Weight>
    <Value>25</Value>
    <Unit>кг</Unit>
  </Weight>
  <Features>
    <Feature>Морозостойкий</Feature>
    <Feature>Экологичный</Feature>
    <Feature>Прочный</Feature>
  </Features>
</TechSpec>
```

## Доступные плейсхолдеры

Внутри JSON значений можно использовать все стандартные плейсхолдеры:

### Данные товара:
- `{product_id}` - ID товара
- `{product_name}` - название товара
- `{product_sku}` - артикул
- `{product_price}` - цена
- `{product_regular_price}` - обычная цена
- `{product_sale_price}` - цена со скидкой
- `{product_description}` - описание
- `{product_short_description}` - краткое описание
- `{product_stock}` - количество на складе
- `{category_name}` - название категории
- `{current_date}` - текущая дата

### Произвольные поля:
- `{meta:field_name}` - произвольное поле товара
- `{meta:field_name.key}` - вложенное поле
- `{term_meta:field_name}` - поле категории
- `{attribute:attribute_name}` - атрибут товара

## Проверка корректности JSON

Перед сохранением убедитесь, что JSON валидный:
1. Используйте онлайн-валидаторы (например, jsonlint.com)
2. Проверьте, что все фигурные скобки `{}` и квадратные скобки `[]` закрыты
3. Убедитесь, что все строки в двойных кавычках `""`
4. Не ставьте запятую после последнего элемента в массиве или объекте

## Отладка

Если вложенные поля не работают:
1. Проверьте логи WordPress (включите WP_DEBUG)
2. Убедитесь, что JSON корректный
3. Проверьте, что тип поля выбран **"Вложенный"**, а не "Текст"
4. Проверьте лог ошибок PHP: ищите сообщения "WC Avito: Ошибка парсинга JSON"

## Ограничения

- JSON должен быть валидным
- Максимальная глубина вложенности не ограничена, но рекомендуется не более 5 уровней
- Имена тегов должны быть валидными XML именами (без пробелов, начинаться с буквы)
- Специальные символы в значениях автоматически экранируются

## Помощь

При возникновении проблем проверьте:
1. Валидность JSON
2. Правильность выбора типа поля
3. Наличие ошибок в логах WordPress
